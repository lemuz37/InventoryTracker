{% extends "base.html" %}
<title>{% block title %}Users{% endblock %}</title>>

{% block content %}
<br />
<div>
    {% if user.admin == True %}
    <h2 align="center">All Users</h2>
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm" cellspacing="0" width="100%" id="user_table">
            <thead>
                <tr>
                    <th scope="col" class="text-center">User Name</th>
                    <th scope="col" class="text-center">User Device(s)</th>
                </tr>
            </thead>
            <tbody>
                {% set count = namespace(value=-1) %}
                {% for user in users %}
                {% set count.value = count.value + 1 %}
                <tr>
                    <td>
                        <table class="table table-sm" cellspacing="0" width="100%">
                            <tbody>
                                <tr>
                                    <th scope="row" class="text-center custom-button-bgrnd"
                                        style="background-color: #66cce7;">{{ user.user_name }}</th>
                                    <td class="text-center">
                                        <!-- Button trigger modal -->
                                        <button type="button" class="btn btn-sm btn-custom btn-edit"
                                            data-bs-toggle="modal" data-bs-target="#editUserModal{{user.id}}">
                                            Edit User
                                        </button>

                                        <!-- Modal -->
                                        <div class="modal fade" id="editUserModal{{user.id}}" tabindex="-1"
                                            role="dialog" aria-labelledby="editUserLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="editUserLabel">Edit User</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form>
                                                            <div class="mb-3">
                                                                <input type="text" class="form-control"
                                                                    name="user_name_{{user.id}}"
                                                                    id="user_name_{{user.id}}" placeholder="Username">
                                                            </div>
                                                            <div class="mb-3">
                                                                <input type="text" class="form-control"
                                                                    name="project_{{user.id}}" id="project_{{user.id}}"
                                                                    placeholder="Project">
                                                            </div>
                                                            <div class="mb-3">
                                                                <input type="text" class="form-control"
                                                                    name="email_{{user.id}}" id="email_{{user.id}}"
                                                                    placeholder="Email">
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <label class="form-label" for="team">Team</label>
                                                                    <select class="form-select" name="team"
                                                                        id="team_{{user.id}}">
                                                                        <option selected>Select Team</option>
                                                                        <option value="Automation">Automation</option>
                                                                        <option value="Hardware">Hardware</option>
                                                                        <option value="Software">Software</option>
                                                                        <option value="System Test">System Test</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-6 d-flex align-items-center">
                                                                    <div class="form-check form-switch">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            role="switch" id="admin_{{user.id}}"
                                                                            name="admin_{{user.id}}" value="on" {% if
                                                                            user.admin %} checked {% endif %}>
                                                                        <label class="form-check-label"
                                                                            for="admin_{{user.id}}">Admin</label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-info" id="edit_user_btn"
                                                            onClick="editUser({{user.id}})">Edit User</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-center">
                                        <!-- Button trigger modal -->
                                        <button type="button" class="btn btn-sm btn-custom btn-update"
                                            data-bs-toggle="modal" data-bs-target="#updatePWModal{{count.value}}">
                                            Update Password
                                        </button>

                                        <!-- Modal -->
                                        <div class="modal fade" id="updatePWModal{{count.value}}" tabindex="-1"
                                            role="dialog" aria-labelledby="updatePWModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="updatePWModalLabel">Update User
                                                            Password
                                                        </h5>
                                                        <button type="button" class="close" data-bs-dismiss="modal"
                                                            aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="container-fluid">
                                                            <div class="row">
                                                                <div class="col-md-2"></div>
                                                                <div class="col-md-8">
                                                                    <form>
                                                                        <div class="form-group">
                                                                            <label for="password1">Password</label>
                                                                            <input type="password" class="form-control"
                                                                                id="password1_{{user.id}}"
                                                                                name="password1"
                                                                                placeholder="Enter password" />
                                                                        </div>
                                                                        <br />
                                                                        <div class="form-group">
                                                                            <label for="password2">Password
                                                                                (Confirm)</label>
                                                                            <input type="password" class="form-control"
                                                                                id="password2_{{user.id}}"
                                                                                name="password2"
                                                                                placeholder="Confirm password" />
                                                                        </div>
                                                                    </form>

                                                                </div>
                                                                <div class="col-md-2"></div>
                                                            </div>
                                                        </div>

                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn"
                                                            style="background-color: #66cce7;"
                                                            onClick="updateUserPassword({{user.id}})">Save
                                                            changes</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <!-- Button trigger modal -->
                                        <button type="button" class="btn btn-sm btn-custom btn-edit"
                                            data-bs-toggle="modal" data-bs-target="#assignDeviceModal{{user.id}}">
                                            Assign Device
                                        </button>

                                        <!-- Modal -->
                                        <div class="modal fade" id="assignDeviceModal{{user.id}}" tabindex="-1"
                                            role="dialog" aria-labelledby="assignDeviceLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="assignDeviceModalLabel">Assign
                                                            Device
                                                        </h5>
                                                        <button type="button" class="close" data-bs-dismiss="modal"
                                                            aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="container-fluid">
                                                            <div class="row">
                                                                <div class="col-md-2"></div>
                                                                <div class="col-md-8">
                                                                    <form>
                                                                        <div class="form-group">
                                                                            <select class="form-control"
                                                                                name="device_category_{{user.id}}"
                                                                                id="device_category_{{user.id}}">
                                                                                <option selected>Select Device Category
                                                                                </option>
                                                                                <option value="ECG">ECG</option>
                                                                                <option value="Vitals">Vitals</option>
                                                                                <option value="Spirometer">Spirometer
                                                                                </option>
                                                                                <option value="Calibration Syringe">
                                                                                    Calibration
                                                                                    Syringe</option>
                                                                                <option value="Simulator">Simulator
                                                                                </option>
                                                                                <option value="Scales">Scales</option>
                                                                                <option value="Engineering Tools">
                                                                                    Engineering Tools</option>
                                                                            </select>
                                                                        </div>
                                                                        <br />
                                                                        <input type="text" class="form-control"
                                                                            name="serial_number_{{user.id}}"
                                                                            id="serial_number_{{user.id}}"
                                                                            placeholder="Serial Number"
                                                                            aria-label="Serial Number" />
                                                                    </form>
                                                                </div>
                                                                <div class="col-md-2"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-sm btn-custom btn-assign"
                                                            id="assign_device_btn" style="background-color: #66cce7;"
                                                            onClick="assignDevice({{user.id}})">Assign Device</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-custom btn-update"
                                            onClick="generateUserQRCode({{user.id}})">Generate QR Code</button>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-custom btn-delete"
                                            data-bs-toggle="modal" data-bs-target="#deleteUserModal{{count.value}}">
                                            Delete User
                                        </button>

                                        <!-- Modal -->
                                        <div class="modal fade" align="center" id="deleteUserModal{{count.value}}"
                                            tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel"
                                            aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deleteUserModalLabel">Are you sure?
                                                        </h5>
                                                        <button type="button" class="close" data-bs-dismiss="modal"
                                                            aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        Are you sure you want to delete this user? <br><br>
                                                        Team: <b>{{user.team}}</b> <br>
                                                        User: <b>{{user.user_name}}</b> <br>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Cancel</button>
                                                        <button type="button" class="btn btn-sm btn-custom btn-delete"
                                                            onClick="deleteUser({{user.id}})">Delete User</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
    </div>
</div>
</div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</td>


<td>
    <table class="table table-striped table-bordered table-sm">
        <thead>
            <tr white-space="wrap">
                <th scope="col" class="text-center">Device Name</th>
                <th scope="col" class="text-center">Model Number</th>
                <th scope="col" class="text-center">Serial Number</th>
                <th scope="col" class="text-center">Calibration Start Date</th>
                <th scope="col" class="text-center">Calibration End Date</th>
                <th scope="col" class="text-center">Project</th>
                <th scope="col" class="text-center">Location</th>
                <th scope="col" class="text-center">Return</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            {% if device.user_name == user.user_name%}
            <tr>
                <th scope="row" class="text-center">{{ device.device_name }}</th>
                <td class="text-center">{{ device.model_number }}</td>
                <td class="text-center">{{ device.serial_number }}</td>
                <td class="text-center">{{ device.calibrationStart.strftime("%m/%d/%Y") }}</td>
                <td class="text-center">{{ device.calibrationEnd.strftime("%m/%d/%Y") }}</td>
                <td class="text-center">{{ device.project }}</td>
                <td class="text-center">{{ device.location }}</td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-custom btn-update"
                        onClick="returnDevice({{ device.id }})">Return</button></td>
            </tr>
            {% endif%}
            {% endfor %}
        </tbody>
    </table>
</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}
</div>
</div>
</form>

{% endblock %}